<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>è§’è‰²è³‡æ–™æª¢è¦–å·¥å…·ï¼ˆè‡ªå‹•è®€å–ç‰ˆï¼‰</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .status-badge { font-size: 0.85rem; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
  </style>
</head>
<body class="bg-body">
  <nav class="navbar navbar-expand-lg bg-primary navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand">è§’è‰²è³‡æ–™å·¥å…·</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="sourceBadge" class="badge bg-light text-dark status-badge d-none"></span>
        <button id="toggleTheme" class="btn btn-outline-light btn-sm">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- æç¤ºå¡ç‰‡ -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">è³‡æ–™ä¾†æº</h5>
        <p class="mb-0 text-muted">æœ¬é é¢æœƒåœ¨è¼‰å…¥å¾Œè‡ªå‹•è®€å–æŒ‡å®šçš„ Google Sheetï¼ˆéœ€è¨­å®šç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººçš†å¯æª¢è¦–ã€ï¼‰ã€‚</p>
        <small class="text-muted">è‹¥è¦æ”¹è®€å…¶ä»–è¡¨å–®ï¼Œå¯åœ¨ç¶²å€åŠ ä¸Šåƒæ•¸ï¼š<code>?sheetId=ä½ çš„sheetId&gid=å·¥ä½œè¡¨gid</code> æˆ– <code>?sheetUrl=å®Œæ•´åˆ†äº«é€£çµ</code>ã€‚</small>
        <div id="msg" class="text-danger mt-2"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">è§’è‰²æ¸…å–®</h5>
          <div class="d-flex align-items-center gap-2">
            <button id="reloadBtn" class="btn btn-outline-primary btn-sm">é‡æ–°æ•´ç†</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-secondary">
              <tr>
                <th>è§’è‰²åç¨±</th>
                <th>è§’è‰²ä»£ç¢¼</th>
                <th>è§’è‰²è·æ¥­</th>
                <th>è§’è‰²ç­‰ç´š</th>
                <th>è§’è‰²ä¹¾è¡¨</th>
                <th>æ‰€åœ¨ç‡Ÿå€</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="6" class="text-center text-muted">å°šæœªè®€å–è³‡æ–™</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* =========================
       å¤œé–“æ¨¡å¼åˆ‡æ›
    ========================= */
    $('#toggleTheme').on('click', function () {
      const html = document.documentElement;
      const isDark = html.getAttribute('data-bs-theme') === 'dark';
      html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
      $(this).text(isDark ? 'ğŸŒ™ å¤œé–“æ¨¡å¼' : 'â˜€ï¸ æ—¥é–“æ¨¡å¼');
    });

    /* =========================
       å…¬ç”¨ï¼šè§£æ URL åƒæ•¸
    ========================= */
    function getQueryParams() {
      const params = new URLSearchParams(window.location.search);
      return Object.fromEntries(params.entries());
    }

    /* =========================
       å…¬ç”¨ï¼šå¾åˆ†äº«é€£çµå– sheetId/gid
    ========================= */
    function parseSheetFromUrl(url) {
      if (!url) return null;
      // æ”¯æ´ï¼šhttps://docs.google.com/spreadsheets/d/{sheetId}/edit?gid=0#gid=0
      const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
      if (!idMatch) return null;
      const sheetId = idMatch[1];
      // å„ªå…ˆè®€å– query çš„ gidï¼›è‹¥ç„¡å‰‡å˜—è©¦å¾ URL æŠ“å– gidï¼›å†ç„¡å‰‡é è¨­ 0
      const urlObj = new URL(url);
      const gid = urlObj.searchParams.get('gid') || (url.includes('#gid=') ? url.split('#gid=')[1] : '0');
      return { sheetId, gid };
    }

    /* =========================
       è®€å– Google Sheetï¼ˆä»¥ CSV åŒ¯å‡ºï¼‰
    ========================= */
    function loadFromSheet(sheetId, gid = '0') {
      $('#msg').text('');
      $('#tableBody').html(`
        <tr>
          <td colspan="6" class="text-center text-muted">è®€å–ä¸­...</td>
        </tr>
      `);

      // å…ˆæ¸…ç©ºèˆŠè³‡æ–™ï¼Œé¿å…èª¤åˆ¤
      $('#tableBody').empty();

      const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

      Papa.parse(csvUrl, {
        download: true,
        skipEmptyLines: true,
        complete: function (result) {
          try {
            if (!result.data || result.data.length < 2) {
              $('#msg').text('æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º');
              renderTable([]);
              return;
            }

            const rows = result.data.slice(1);
            const data = rows
              .map((r) => ({
                name: r[1], // B
                code: r[2], // C
                job:  r[3], // D
                level:r[4], // E
                attack:  r[6], // F ä¹¾è¡¨
                camp: r[9]  // G æ‰€åœ¨ç‡Ÿå€
              }))
              .filter((r) => r && r.name);

            renderTable(data);
          } catch (e) {
            console.error(e);
            $('#msg').text('è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            renderTable([]);
          }
        },  
        error: function (err) {
          console.error(err);
          $('#msg').text('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè©² Google Sheet å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ã€‚');
          renderTable([]);
        }
      });
    }

    /* =========================
       Render Table
    ========================= */

    function renderTable(data) {
      if (!data || !data.length) {
        $('#tableBody').html(`
          <tr>
            <td colspan="6" class="text-center text-muted">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td>
          </tr>
        `);
        return;
      }

      // ä¾ã€Œæ‰€åœ¨ç‡Ÿå€ã€åˆ†çµ„ï¼ˆç¬¬ä¸€ç‡Ÿå€ã€ç¬¬äºŒç‡Ÿå€...ï¼‰ï¼Œæœªå¡«æˆ–å…¶ä»–æ”¾æœ€å¾Œ
      const groups = {};
      for (const r of data) {
        const key = (r.camp || 'æœªå¡«å¯«').toString().trim();
        if (!groups[key]) groups[key] = [];
        groups[key].push(r);
      }

      // ä¸­æ–‡æ•¸å­—è½‰é˜¿æ‹‰ä¼¯æ•¸å­—ï¼Œç”¨æ–¼ã€ç¬¬Xç‡Ÿå€ã€æ’åº
      const mapCN = { 'é›¶':0,'ã€‡':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10 };
      function chineseNumToInt(txt) {
        if (!txt) return NaN;
        // è™•ç†å¦‚ã€Œç¬¬ä¸€ã€ã€Œç¬¬äºŒåã€ã€Œç¬¬åäºŒã€ç­‰
        const s = txt.replace(/[^é›¶ã€‡ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/g,'');
        if (!s) return NaN;
        if (s.length === 1) return mapCN[s] ?? NaN;
        // åX / Xå / XåY
        if (s === 'å') return 10;
        const tenIdx = s.indexOf('å');
        if (tenIdx === -1) return (mapCN[s[0]] ?? NaN); // å–®å­—
        const left = tenIdx === 0 ? 1 : (mapCN[s[0]] ?? 0);
        const right = tenIdx === s.length - 1 ? 0 : (mapCN[s[tenIdx+1]] ?? 0);
        return left * 10 + right;
      }

      const orderedKeys = Object.keys(groups).sort((a,b) => {
        if (a === 'æœªå¡«å¯«') return 1;
        if (b === 'æœªå¡«å¯«') return -1;
        const na = chineseNumToInt(a);
        const nb = chineseNumToInt(b);
        if (!isNaN(na) && !isNaN(nb)) return na - nb;
        if (!isNaN(na)) return -1;
        if (!isNaN(nb)) return 1;
        return a.localeCompare(b, 'zh-Hant');
      });

      let html = '';
      for (const k of orderedKeys) {
        html += `
          <tr class="group-row">
            <td colspan="6">æ‰€åœ¨ç‡Ÿå€ï¼š${k}ï¼ˆ${groups[k].length}ï¼‰</td>
          </tr>`;
        html += groups[k].map(r => `
          <tr>
            <td>${r.name ?? ''}</td>
            <td>${r.code ?? ''}</td>
            <td>${r.job ?? ''}</td>
            <td>${r.level ?? ''}</td>
            <td>${r.attack ?? ''}</td>
            <td>${r.camp ?? ''}</td>
          </tr>`).join('');
      }

      $('#tableBody').html(html);
    }

    /* =========================
       å•Ÿå‹•æµç¨‹ï¼šè‡ªå‹•è®€å–
    ========================= */
    const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0';

    function resolveSheetTarget() {
      const qp = getQueryParams();

      // 1) å…è¨± ?sheetUrl=
      if (qp.sheetUrl) {
        const parsed = parseSheetFromUrl(qp.sheetUrl);
        if (parsed) return parsed;
      }

      // 2) å…è¨± ?sheetId= èˆ‡å¯é¸ ?gid=
      if (qp.sheetId) {
        return { sheetId: qp.sheetId, gid: qp.gid || '0' };
      }

      // 3) é è¨­ä½¿ç”¨å…§å»ºé€£çµ
      const parsedDefault = parseSheetFromUrl(DEFAULT_SHEET_URL);
      return parsedDefault || { sheetId: '', gid: '0' };
    }

    function updateSourceBadge(sheetId, gid) {
      if (!sheetId) return;
      const badge = $('#sourceBadge');
      badge.text(`sheetId=${sheetId} | gid=${gid}`);
      badge.removeClass('d-none');
    }

    $(function () {
      const target = resolveSheetTarget();
      if (!target.sheetId) {
        $('#msg').text('ç„¡æ³•è§£ææŒ‡å®šçš„ Google Sheet é€£çµæˆ– sheetId');
        return;
      }

      updateSourceBadge(target.sheetId, target.gid);
      loadFromSheet(target.sheetId, target.gid);

      $('#reloadBtn').on('click', function () {
        loadFromSheet(target.sheetId, target.gid);
      });
    });
  </script>
</body>
</html>
