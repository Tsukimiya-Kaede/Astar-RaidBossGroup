
<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>è§’è‰²è³‡æ–™æª¢è¦–å·¥å…·ï¼ˆè‡ªå‹•è®€å–ç‰ˆï¼‰</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Bootstrap JS (Modal éœ€è¦) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .status-badge { font-size: 0.85rem; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
    button.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
  </style>
</head>
<body class="bg-body">
  <nav class="navbar navbar-expand-lg bg-primary navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand">è§’è‰²è³‡æ–™å·¥å…·-1125</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="sourceBadge" class="badge bg-light text-dark status-badge d-none"></span>
        <button id="toggleTheme" class="btn btn-outline-light btn-sm">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- æç¤ºå¡ç‰‡ -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">è³‡æ–™ä¾†æº</h5>
        <p class="mb-0 text-muted">è«‹å„ä½æª¢è¦–ä¸€ä¸‹è‡ªå·±çš„è³‡æ–™æ˜¯å¦é ˆæ›´æ–°ï¼Œè‹¥è¦æ›´æ–°è«‹é»æ“Šã€ä¿®æ”¹ã€‘æŒ‰éˆ•é€²è¡Œæ›´æ–°ã€‚è‹¥é‡ç„¡æ³•æ›´æ–°æƒ…å½¢è«‹é€²ä»¥ä¸‹ç¶²å€é€²å…¥Excelè¡¨æ‰¾åˆ°è‡ªå·±çš„æ¬„ä½æ›´æ–°è³‡æ–™ ã€€ï½æ„Ÿæ©çš„å¿ƒï½</p>
        <small class="text-muted">
		  <a href="https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0"
			 target="_blank" rel="noopener noreferrer">
			https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0
		  </a>
		</small>
        <div id="msg" class="text-danger mt-2"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">è§’è‰²æ¸…å–®</h5>
          <div class="d-flex align-items-center gap-2">
            <button id="addBtn" class="btn btn-primary btn-sm">æ–°å¢è§’è‰²</button>
            <button id="reloadBtn" class="btn btn-outline-secondary btn-sm">é‡æ–°æ•´ç†</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-secondary">
              <tr>
                <th>è§’è‰²åç¨±</th>
                <th>è§’è‰²ä»£ç¢¼</th>
                <th>è§’è‰²è·æ¥­</th>
                <th>è§’è‰²ç­‰ç´š</th>
                <th>è§’è‰²ä¹¾è¡¨</th>
                <th>æ‰€åœ¨ç‡Ÿå€</th>
                <th>ä¿®æ”¹è³‡æ–™</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="7" class="text-center text-muted">å°šæœªè®€å–è³‡æ–™</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   è¨­å®šï¼šè«‹å¡«ä½ çš„ Apps Script Web Appï¼ˆexecï¼‰URL
========================= */
const GAS_UPDATE_URL = 'https://script.google.com/macros/s/AKfycbwbEW15caNLWOUqm8VKby2tN_JfCySTT6xFtreuFz9K0Ex51qioyeqNi476jVH4vlGo/exec';
// ä¾‹å¦‚ï¼šconst GAS_UPDATE_URL = 'https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0';

/* =========================
   å¤œé–“æ¨¡å¼åˆ‡æ›
========================= */
$('#toggleTheme').on('click', function () {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-bs-theme') === 'dark';
  html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
  $(this).text(isDark ? 'ğŸŒ™ å¤œé–“æ¨¡å¼' : 'â˜€ï¸ æ—¥é–“æ¨¡å¼');
});

/* =========================
   å…¬ç”¨ï¼šè§£æ URL åƒæ•¸
========================= */
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return Object.fromEntries(params.entries());
}

/* =========================
   å…¬ç”¨ï¼šå¾åˆ†äº«é€£çµå– sheetId/gid
========================= */
function parseSheetFromUrl(url) {
  if (!url) return null;
  const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
  if (!idMatch) return null;
  const sheetId = idMatch[1];
  const urlObj = new URL(url);
  const gid = urlObj.searchParams.get('gid') || (url.includes('#gid=') ? url.split('#gid=')[1] : '0');
  return { sheetId, gid };
}

/* =========================
   è®€å– Google Sheetï¼ˆä»¥ CSV åŒ¯å‡ºï¼‰
========================= */
function loadFromSheet(sheetId, gid = '0') {
  $('#msg').text('');
  $('#tableBody').html(`
    <tr>
      <td colspan="7" class="text-center text-muted">è®€å–ä¸­...</td>
    </tr>
  `);

  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

  Papa.parse(csvUrl, {
    download: true,
    skipEmptyLines: true,
    complete: function (result) {
      try {
        if (!result.data || result.data.length < 2) {
          $('#msg').text('æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º');
          renderTable([]);
          return;
        }

        const rows = result.data.slice(1);
        const data = rows
          .map((r, i) => ({
            name:  r[1], // B
            code:  r[2], // Cï¼ˆä¸»éµï¼‰
            job:   r[3], // D
            level: r[4], // E
            attack:r[6], // F ä¹¾è¡¨  â† è‹¥ä½ çš„è¡¨ä¸æ˜¯åœ¨ F/Gï¼Œè«‹ä¾å¯¦éš›æ¬„ä½èª¿æ•´
            camp:  r[9], // G ç‡Ÿå€
            rowIndex: i + 2 // å«æ¨™é¡Œåˆ—
          }))
          .filter(r => r && r.name);

        renderTable(data);
      } catch (e) {
        console.error(e);
        $('#msg').text('è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
        renderTable([]);
      }
    },  
    error: function (err) {
      console.error(err);
      $('#msg').text('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè©² Google Sheet å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ã€‚');
      renderTable([]);
    }
  });
}

/* =========================					
   Render Table
========================= */
function renderTable(data) {
  if (!data || !data.length) {
    $('#tableBody').html(`
      <tr>
        <td colspan="7" class="text-center text-muted">æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td>
      </tr>
    `);
    return;
  }

  const groups = {};
  for (const r of data) {
    const key = (r.camp || 'æœªå¡«å¯«').toString().trim();
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  }

  const mapCN = { 'é›¶':0,'ã€‡':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10 };
  function chineseNumToInt(txt) {
    if (!txt) return NaN;
    const s = txt.replace(/[^é›¶ã€‡ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/g,'');
    if (!s) return NaN;
    if (s === 'å') return 10;
    const tenIdx = s.indexOf('å');
    if (tenIdx === -1) return mapCN[s] ?? NaN;
    const left = tenIdx === 0 ? 1 : (mapCN[s[0]] ?? 0);
    const right = tenIdx === s.length - 1 ? 0 : (mapCN[s[tenIdx+1]] ?? 0);
    return left * 10 + right;
  }

  const orderedKeys = Object.keys(groups).sort((a,b) => {
    if (a === 'æœªå¡«å¯«') return 1;
    if (b === 'æœªå¡«å¯«') return -1;
    const na = chineseNumToInt(a);
    const nb = chineseNumToInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    if (!isNaN(na)) return -1;
    if (!isNaN(nb)) return 1;
    return a.localeCompare(b, 'zh-Hant');
  });

  let html = '';
  for (const k of orderedKeys) {
    html += `
      <tr class="group-row">
        <td colspan="7">æ‰€åœ¨ç‡Ÿå€ï¼š${k}ï¼ˆ${groups[k].length}ï¼‰</td>
      </tr>`;
    html += groups[k].map(r => `
      <tr>
        <td>${r.name ?? ''}</td>
        <td>${r.code ?? ''}</td>
        <td>${r.job ?? ''}</td>
        <td>${r.level ?? ''}</td>
        <td>${r.attack ?? ''}</td>
        <td>${r.camp ?? ''}</td>
        <td>
          <button class="btn btn-outline-secondary btn-edit"
            data-row="${r.rowIndex || ''}"
            data-name="${r.name ?? ''}"
            data-code="${r.code ?? ''}"
            data-job="${r.job ?? ''}"
            data-level="${r.level ?? ''}"
            data-attack="${r.attack ?? ''}"
            data-camp="${r.camp ?? ''}">ä¿®æ”¹</button>
        </td>
      </tr>`).join('');
  }

  $('#tableBody').html(html);

  // ç¶å®šã€Œä¿®æ”¹ã€â†’ æ‰“é–‹ç·¨è¼¯å™¨
  $('#tableBody').off('click', '.btn-edit').on('click', '.btn-edit', function(){
    const $btn = $(this);
    openEditor({
      name:  $btn.data('name'),
      code:  $btn.data('code'),
      job:   $btn.data('job'),
      level: $btn.data('level'),
      attack:$btn.data('attack'),
      camp:  $btn.data('camp'),
      rowIndex: Number($btn.data('row') || 0)
    }, (updated) => {
      // å„²å­˜æˆåŠŸå¾Œï¼Œæ›´æ–°å‰ç«¯è©²åˆ—é¡¯ç¤ºèˆ‡æŒ‰éˆ• data
      const tr = $btn.closest('tr')[0];
      const tds = tr.querySelectorAll('td');
      tds[0].textContent = updated.name;
      tds[1].textContent = updated.code;
      tds[2].textContent = updated.job;
      tds[3].textContent = updated.level;
      tds[4].textContent = updated.attack;
      tds[5].textContent = updated.camp;

      $btn.data('name',  updated.name);
      $btn.data('code',  updated.code);
      $btn.data('job',   updated.job);
      $btn.data('level', updated.level);
      $btn.data('attack',updated.attack);
      $btn.data('camp',  updated.camp);
    });
  });
}

/* =========================
   å•Ÿå‹•æµç¨‹ï¼šè‡ªå‹•è®€å–
========================= */
const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0';

function resolveSheetTarget() {
  const qp = getQueryParams();
  if (qp.sheetUrl) {
    const parsed = parseSheetFromUrl(qp.sheetUrl);
    if (parsed) return parsed;
  }
  if (qp.sheetId) {
    return { sheetId: qp.sheetId, gid: qp.gid || '0' };
  }
  const parsedDefault = parseSheetFromUrl(DEFAULT_SHEET_URL);
  return parsedDefault || { sheetId: '', gid: '0' };
}

function updateSourceBadge(sheetId, gid) {
  if (!sheetId) return;
  const badge = $('#sourceBadge');
  badge.text(`sheetId=${sheetId} | gid=${gid}`);
  badge.removeClass('d-none');
}

$(function () {
  const target = resolveSheetTarget();
  if (!target.sheetId) {
    $('#msg').text('ç„¡æ³•è§£ææŒ‡å®šçš„ Google Sheet é€£çµæˆ– sheetId');
    return;
  }
  updateSourceBadge(target.sheetId, target.gid);
  loadFromSheet(target.sheetId, target.gid);

  $('#reloadBtn').on('click', function () {
    loadFromSheet(target.sheetId, target.gid);
  });
$('#addBtn').on('click', function () {
  // é–‹ç©ºç™½çš„ç·¨è¼¯å™¨
  openEditor({
    name:   '',
    code:   '',   // æ–°å¢æ™‚è«‹è¼¸å…¥ codeï¼ˆå¾Œç«¯ä»¥æ­¤ç‚ºä¸»éµï¼‰
    job:    '',
    level:  '',
    attack: '',
    camp:   '',
    rowIndex: 0,
	__isNew: true
  }, (updated) => {
    // å„²å­˜æˆåŠŸçš„å›å‘¼ï¼ˆç›®å‰å¾Œç«¯åªæ”¯æ´æ›´æ–°æ—¢æœ‰åˆ—ï¼‰
    // è‹¥ä½ æœªä¾†æ”¹æˆ upsert/appendï¼Œé€™è£¡å¯ä»¥é¸æ“‡é‡æ–°æ•´ç†åˆ—è¡¨ï¼š
    // loadFromSheet(resolveSheetTarget().sheetId, resolveSheetTarget().gid);
    alert('å·²æ–°å¢');
  });
});

});

/* =========================
   ç·¨è¼¯è¦–çª—ï¼ˆå«ç‡Ÿå€ä¸‹æ‹‰ï¼‰
========================= */
function createEditor() {
  const overlay = document.createElement('div');
  overlay.id = 'editOverlay';
  Object.assign(overlay.style, {
    position: 'fixed', inset: 0, background: 'rgba(0,0,0,.4)',
    display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
  });

  const card = document.createElement('div');
  Object.assign(card.style, {
    background: '#fff', borderRadius: '12px', padding: '18px', width: 'min(520px, 92vw)',
    boxShadow: '0 10px 30px rgba(0,0,0,.2)', color: '#222', fontFamily: 'system-ui,-apple-system,BlinkMacSystemFont'
  });
  card.innerHTML = `
    <h3 style="margin:0 0 12px;font-size:18px;width:100%; max-width:100%; box-sizing:border-box;">ä¿®æ”¹è³‡æ–™</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²åç¨±ï¼ˆBï¼‰</span>
        <input id="edit_name" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ä»£ç¢¼ï¼ˆCï¼‰</span>
        <input id="edit_code" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²è·æ¥­ï¼ˆDï¼‰</span>
        <input id="edit_job" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ç­‰ç´šï¼ˆEï¼‰</span>
        <input id="edit_level" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ä¹¾è¡¨ï¼ˆFï¼‰</span>
        <input id="edit_attack" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>æ‰€åœ¨ç‡Ÿå€ï¼ˆGï¼‰</span>
        <select id="edit_camp" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <option>ç¬¬ä¸€è»ç‡Ÿ</option>
          <option>ç¬¬äºŒè»ç‡Ÿ</option>
          <option>ç¬¬ä¸‰è»ç‡Ÿ</option>
          <option>ç¬¬å››è»ç‡Ÿ</option>
          <option>ç¬¬äº”è»ç‡Ÿ</option>
          <option>ç¬¬å…­è»ç‡Ÿ</option>
          <option>ç¬¬ä¸ƒè»ç‡Ÿ</option>
          <option>ç¬¬å…«è»ç‡Ÿ</option>
          <option>ç¬¬ä¹è»ç‡Ÿ</option>
          <option>ç¬¬åè»ç‡Ÿ</option>
          <option>è¨“ç·´ç‡Ÿ</option>
          <option>å¤–æ´å¤§å¤§</option>
        </select>
      </label>
    </div>
    <div class="d-flex gap-2 justify-content-end mt-3">
      <button id="btn_cancel" class="btn btn-light border">å–æ¶ˆ</button>
      <button id="btn_save" class="btn btn-primary">å„²å­˜</button>
    </div>
  `;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  return overlay;
}

function openEditor(values, onSave) {
  // å–å¾—æˆ–å»ºç«‹ overlay
  let overlay = document.getElementById('editOverlay');
  if (!overlay) overlay = createEditor();

  // æŒ‡æ´¾å€¼
  overlay.querySelector('#edit_name').value   = values.name  ?? '';
  overlay.querySelector('#edit_code').value   = values.code  ?? '';
  overlay.querySelector('#edit_job').value    = values.job   ?? '';
  overlay.querySelector('#edit_level').value  = values.level ?? '';
  overlay.querySelector('#edit_attack').value = values.attack?? '';

  const campSelect = overlay.querySelector('#edit_camp');
  const campValue  = values.camp ?? '';
  if (campValue) {
    const exists = Array.from(campSelect.options).some(o => o.value === campValue || o.text === campValue);
    if (!exists) campSelect.add(new Option(campValue, campValue));
    campSelect.value = campValue;
  } else {
    campSelect.value = '';
  }

  // ç¶å®šäº‹ä»¶
  const btnCancel = overlay.querySelector('#btn_cancel');
  const btnSave   = overlay.querySelector('#btn_save');

  const close = () => overlay.remove();

  btnCancel.onclick = close;

  // ğŸ”¥ å„²å­˜ â†’ å‘¼å« GAS å¯«å›ï¼ˆä»¥ã€Œè§’è‰²ä»£ç¢¼ã€ç‚ºä¸»éµï¼‰
  btnSave.onclick = async () => {
  const updated = {
    name:   overlay.querySelector('#edit_name').value.trim(),
    code:   overlay.querySelector('#edit_code').value.trim(),  // ä¸»éµï¼ˆCæ¬„ï¼‰
    job:    overlay.querySelector('#edit_job').value.trim(),
    level:  overlay.querySelector('#edit_level').value.trim(),
    attack: overlay.querySelector('#edit_attack').value.trim(),
    camp:   overlay.querySelector('#edit_camp').value.trim(),
  };
  const isNew = !!values.__isNew; // â† ç”±æ–°å¢æŒ‰éˆ•å¸¶å…¥

  if (!GAS_UPDATE_URL || GAS_UPDATE_URL.includes('/dev')) {
    alert('è«‹è¨­å®šæ­£ç¢ºçš„ GAS_UPDATE_URLï¼ˆå¿…é ˆæ˜¯ /execï¼‰');
    return;
  }
  if (!updated.code) {
    alert('è§’è‰²ä»£ç¢¼ä¸å¯ç‚ºç©ºï¼ˆç”¨ä¾†å®šä½è¦æ›´æ–°çš„åˆ—ï¼‰');
    return;
  }

  try {
    // x-www-form-urlencodedï¼ŒGAS ç”¨ e.parameter è®€
    const form = new URLSearchParams();
    form.set('action', 'upsertByCode'); // â† é‡é»ï¼šçµ±ä¸€å‘¼å« upsert
    form.set('code',   updated.code);
    form.set('name',   updated.name);
    form.set('job',    updated.job);
    form.set('level',  updated.level);
    form.set('attack', updated.attack);
    form.set('camp',   updated.camp);

    const resp = await fetch(GAS_UPDATE_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString(),
      cache: 'no-store',
      redirect: 'follow'
    });

    const text = await resp.text();
    let result;
    try { result = JSON.parse(text); } catch {
      throw new Error('GAS å›å‚³é JSONï¼Œè«‹ç¢ºèª Web App ç”¨ /exec ä¸”ã€Œä»»ä½•äººã€å¯å­˜å–ã€‚');
    }
    if (!resp.ok || result.status !== 'ok') {
      throw new Error(result.message || 'æ›´æ–°/æ–°å¢å¤±æ•—');
    }

    if (isNew) {
      // æ–°å¢ï¼šç‚ºäº†æ­£ç¢ºåˆ†é¡/é¡¯ç¤ºï¼Œç›´æ¥é‡æŠ“ä¸€æ¬¡
      const t = resolveSheetTarget();
      loadFromSheet(t.sheetId, t.gid);
    } else {
      // æ›´æ–°ï¼šç›´æ¥åˆ·æ–°ç•¶åˆ—
      onSave?.(updated);
    }

    alert(isNew ? 'æ–°å¢æˆåŠŸï¼' : 'æ›´æ–°æˆåŠŸï¼');
    close();
  } catch (e) {
    console.error(e);
    alert('é€å‡ºå¤±æ•—ï¼š' + e.message);
  }
};


}
</script>
</body>
</html>
