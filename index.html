<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Astar 公會｜Raid 組隊中心 v3</title>
<meta name="description" content="Astar 公會專用：公會成員名單、隊伍配對、意見回應、匯入/匯出、Google Sheet 連動。單一 HTML，RWD，無外部依賴。" />
<meta name="theme-color" content="#0B0F1A" />
<style>
:root{ --bg:#0B0F1A; --fg:#E5E7EB; --muted:#94A3B8; --card:rgba(255,255,255,.08); --accent1:#7C3AED; --accent2:#06B6D4; --radius:18px; --shadow:0 12px 30px rgba(0,0,0,.35) }
*{box-sizing:border-box}
body{margin:0;color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,"PingFang TC","Microsoft JhengHei";background:
  radial-gradient(1200px 600px at 110% -10%, rgba(124,58,237,.18), transparent 60%),
  radial-gradient(1000px 600px at -10% 110%, rgba(6,182,212,.18), transparent 60%), #0B0F1A}
.container{max-width:1200px;margin:0 auto;padding:20px}
header{position:sticky;top:0;z-index:20;background:rgba(11,15,26,.6);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
.nav{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 20px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 8px 24px rgba(124,58,237,.35), inset 0 0 0 2px rgba(255,255,255,.12)}
.tabs{display:flex;gap:8px;align-items:center}
.tab-btn{padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.1);background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));color:var(--fg);font-weight:600;cursor:pointer}
.tab-btn.active{background:linear-gradient(135deg, rgba(124,58,237,.65), rgba(6,182,212,.65));color:#fff;border-color:transparent}
.burger{display:none;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px 10px}
.burger span{display:block;width:22px;height:2px;background:#fff;margin:5px 0}
.card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px)}
.card-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.card-body{padding:16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.row>*{flex:1}
.row.inline>*{flex:unset}
input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--fg)}
input:focus,select:focus,textarea:focus{border-color:rgba(6,182,212,.8);outline:none}
.btn{padding:10px 14px;border-radius:12px;border:none;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2))}
.btn.subtle{background:rgba(255,255,255,.06);color:var(--fg);border:1px solid rgba(255,255,255,.08)}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table thead th{position:sticky;top:0;background:rgba(11,15,26,.9);padding:8px 10px;font-size:12px;color:var(--muted);text-align:left}
.table tbody td{padding:12px 10px;border-top:1px solid rgba(255,255,255,.06)}
.scroll{max-height:420px;overflow:auto}
.hidden{display:none!important}
.muted{color:var(--muted)}
.toast{position:fixed;right:20px;bottom:20px;display:flex;flex-direction:column;gap:8px;z-index:50}
.toast .t{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
.mobile-menu{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(4px);z-index:30}
.mobile-sheet{position:absolute;left:0;top:0;bottom:0;width:78%;max-width:320px;background:rgba(17,24,39,.9);border-right:1px solid rgba(255,255,255,.08);padding:16px 12px}
.mobile-sheet .tab-btn{display:block;width:100%;text-align:left;margin:6px 0}
.footer{padding:30px 0;color:var(--muted);text-align:center}
/* 下拉選項為黑字 */
#filterClass option{color:#111827;background:#fff}
/* 拖拉區 */
.dropzone{min-height:70px;padding:8px;border:1px dashed rgba(255,255,255,.2);border-radius:14px}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand"><div class="logo"></div><h1 style="margin:0;font-size:18px">Astar 公會｜Raid 組隊中心 v3</h1></div>
    <div class="tabs" role="tablist">
      <button class="tab-btn active" data-tab="members">公會成員</button>
      <button class="tab-btn" data-tab="match">組隊配對</button>
      <button class="tab-btn" data-tab="feedback">意見回應</button>
      <button class="tab-btn" data-tab="io">匯入/匯出</button>
      <button class="tab-btn" data-tab="settings">連線設定</button>
    </div>
    <button class="burger" aria-label="開啟選單"><span></span><span></span><span></span></button>
  </div>
</header>
<div class="mobile-menu" id="mobileMenu" aria-hidden="true">
  <div class="mobile-sheet">
    <button class="tab-btn active" data-tab="members">公會成員</button>
    <button class="tab-btn" data-tab="match">組隊配對</button>
    <button class="tab-btn" data-tab="feedback">意見回應</button>
    <button class="tab-btn" data-tab="io">匯入/匯出</button>
    <button class="tab-btn" data-tab="settings">連線設定</button>
  </div>
</div>

<main class="container">
  <!-- 公會成員（按你指定的七欄顯示） -->
  <section id="tab-members" class="tab">
    <div class="card">
      <div class="card-header">
        <div class="row inline" style="gap:8px;align-items:center">
          <strong>公會成員</strong>
          <span class="muted">（啟動自動從 Google Sheet 讀取「基本資料表」）</span>
        </div>
        <div class="row inline">
          <input id="searchInput" placeholder="搜尋 名稱/職業/營區/乾表…" style="min-width:220px" />
          <button class="btn subtle" id="refreshBtn">重新整理</button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <select id="filterClass">
            <option value="">職業別</option>
            <option>初新者</option><option>龍騎士</option><option>十字軍</option><option>騎士</option>
            <option>神偷</option><option>暗殺者</option><option>遊俠</option><option>狙擊手</option>
            <option>冰魔導士</option><option>火魔導士</option><option>祭司</option><option>神槍手</option><option>格鬥家</option>
          </select>
          <input id="filterLevelMin" type="number" placeholder="最低等級" />
        </div>
        <div class="scroll" id="memberTableWrap" aria-live="polite">
          <table class="table" id="memberTable">
            <thead>
              <tr>
                <th>角色名稱</th>
                <th>角色職業</th>
                <th>等級</th>
                <th>乾表</th>
                <th>所在營區</th>
                <th>公會成員</th>
                <th>角色代碼</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- 組隊配對（以等級=戰力簡化評分） -->
  <section id="tab-match" class="tab hidden">
    <div class="grid" style="grid-template-columns:1.2fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header">
          <strong>配對條件</strong>
          <div class="row inline"><button class="btn subtle" id="btnDemoTeam">載入示例</button><button class="btn" id="btnSuggest">一鍵建議隊伍</button></div>
        </div>
        <div class="card-body">
          <div class="row"><input id="raidName" placeholder="Raid 名稱（例：黑魔 12 人）" /><input id="raidTime" placeholder="時間（例：2025-12-24 20:30）" /></div>
          <div class="row">
            <label class="pill">隊伍人數 <input id="needTotal" type="number" min="1" value="12" style="width:90px;margin-left:8px"></label>
            <label class="pill">每職業上限 <input id="perClassCap" type="number" min="0" value="3" style="width:90px;margin-left:8px"></label>
            <input id="minLevel" type="number" placeholder="最低等級（例：200）" />
          </div>
          <div class="row"><textarea id="mustList" rows="2" placeholder="必帶（以逗號分隔 角色名稱）"></textarea><textarea id="banList" rows="2" placeholder="黑名單（以逗號分隔 角色名稱）"></textarea></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><strong>建議隊伍（可拖拉微調）</strong><div class="row inline"><button class="btn subtle" id="btnClearTeam">清空</button><button class="btn" id="btnExportTeam">輸出隊伍</button></div></div>
        <div class="card-body">
          <div class="dropzone" id="zone-team"></div>
          <div class="row inline" style="margin-top:10px"><div id="teamSummary" class="muted">尚未產生隊伍</div><span class="pill right" id="teamScore">分數：0</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 意見回應 -->
  <section id="tab-feedback" class="tab hidden">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header"><strong>新增意見</strong><button class="btn" id="btnAddFeedback">送出</button></div>
        <div class="card-body">
          <div class="row"><input id="fbName" placeholder="暱稱（可留空）" /><select id="fbType"><option>Bug</option><option>優化</option><option>資料修正</option><option>活動建議</option></select></div>
          <textarea id="fbContent" rows="4" placeholder="請輸入內容…"></textarea>
          <div class="row inline" style="margin-top:8px"><label class="pill"><input type="checkbox" id="fbPublic" checked style="margin-right:6px">送出後公開顯示</label><span class="muted">可於列表自行編輯/刪除</span></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><strong>意見牆</strong><div class="row inline"><input id="fbSearch" placeholder="搜尋意見…" /><button class="btn subtle" id="btnClearFB">清空全部（本機）</button></div></div>
        <div class="card-body"><div id="fbList" class="scroll" aria-live="polite"></div></div>
      </div>
    </div>
  </section>

  <!-- 匯入/匯出 -->
  <section id="tab-io" class="tab hidden">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header"><strong>本地下載 / 暫存</strong><div class="row inline"><button class="btn" id="btnExportJSON">下載 JSON</button><button class="btn" id="btnExportCSV">下載 CSV</button></div></div>
        <div class="card-body">
          <p class="muted">會打包目前成員快照、隊伍配置與偏好設定。</p>
          <div class="row inline"><input type="file" id="fileImport" accept=".json,.csv" /><button class="btn subtle" id="btnImport">匯入檔案</button></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><strong>隊伍卡快照（PNG）</strong><button class="btn" id="btnSnapshot">產生圖片</button></div>
        <div class="card-body"><canvas id="snapshotCanvas" width="1000" height="560" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.1);"></canvas></div>
      </div>
    </div>
  </section>

  <!-- 連線設定 -->
  <section id="tab-settings" class="tab hidden">
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div class="card-header"><strong>Google Sheet 讀取</strong><div class="row inline"><button class="btn" id="btnLoadSheet">撈取資料</button><button class="btn subtle" id="btnSaveEndpoint">保存設定</button></div></div>
        <div class="card-body">
          <label>Sheet 編輯 URL 或發佈 CSV 端點</label>
          <input id="sheetUrl" />
          <label style="margin-top:10px">工作表名稱（預設：基本資料表）</label>
          <input id="sheetName" placeholder="基本資料表" />
          <p class="muted">若貼編輯連結，系統會自動嘗試 `export?format=csv&gid=` 與 `gviz/tq?tqx=out:csv&sheet=` 兩種方式。</p>
        </div>
      </div>
      <div class="card">
        <div class="card-header"><strong>寫入（Apps Script）</strong><button class="btn subtle" id="btnTestPost">測試上傳</button></div>
        <div class="card-body">
          <label>GAS Web App URL（doPost）</label>
          <input id="gasUrl" placeholder="https://script.google.com/.../exec" />
          <label style="margin-top:10px">Token（簡易驗證，可留空）</label>
          <input id="gasToken" placeholder="可選" />
        </div>
      </div>
    </div>
  </section>

  <div class="footer">Astar Guild · v3 · 單檔版 · 自動撈取</div>
</main>
<div class="toast" id="toast"></div>

<script>
/********** 工具 **********/
const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>Array.from(e.querySelectorAll(s));
const toast=(m,ms=1800)=>{const t=document.createElement('div'); t.className='t'; t.textContent=m; $('#toast').appendChild(t); setTimeout(()=>t.remove(),ms)};
const download=(name,content,type='application/json')=>{const b=new Blob([content],{type}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(u),1e3)};
const toCSV=(rows)=>{if(!rows.length) return ''; const esc=v=>'"'+String(v??'').replace(/"/g,'""')+'"'; const h=Object.keys(rows[0]); return [h.join(','),...rows.map(r=>h.map(k=>esc(r[k])).join(','))].join('\n')};

/********** 狀態 **********/
const Store={k:'astar-v3',load(){try{return JSON.parse(localStorage.getItem(this.k)||'{}')}catch{return{}}},save(d){localStorage.setItem(this.k,JSON.stringify(d))}};
let app=Object.assign({members:[],team:[],settings:{sheetUrl:'',sheetName:'基本資料表',gasUrl:'',gasToken:''},feedback:[]},Store.load());
const saveApp=()=>Store.save(app);

/********** 連線：Google Sheet 轉 CSV（多端點嘗試） **********/
function toCsvUrl(editUrl, sheetName){
  if(!editUrl) return '';
  if(/\b(out:csv|format=csv)\b/i.test(editUrl)) return editUrl;
  const idm=editUrl.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); const gidm=editUrl.match(/[?#&]gid=(\d+)/);
  if(idm){ const id=idm[1]; const name=encodeURIComponent(sheetName||'基本資料表'); if(gidm){return `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gidm[1]}`} return `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${name}`; }
  return editUrl;
}
async function tryLoadSheet(editUrl, sheetName){
  $('#memberTableWrap').setAttribute('aria-busy','true');
  const idm=(editUrl||'').match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); const gidm=(editUrl||'').match(/[?#&]gid=(\d+)/); const id=idm? idm[1]:null; const gid=gidm? gidm[1]:null; const name=encodeURIComponent(sheetName||'基本資料表');
  const candidates=[]; if(id&&gid) candidates.push(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`); if(id) candidates.push(`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv&sheet=${name}`); candidates.push(toCsvUrl(editUrl, sheetName));
  let lastErr='';
  for(const url of candidates){ try{ const res=await fetch(url,{cache:'no-store'}); if(!res.ok){ lastErr=`HTTP ${res.status}`; continue;} const text=await res.text(); if(!text||!/,/.test(text)){ lastErr='空白或非 CSV'; continue;} await loadFromCSVText(text); toast('載入成功'); $('#memberTableWrap').setAttribute('aria-busy','false'); return true; }catch(e){ lastErr=e.message } }
  toast('載入失敗：請確認試算表「擁有連結者可檢視」，或使用「發佈到網路」的 CSV 連結。'); console.error('Load fail', lastErr); $('#memberTableWrap').setAttribute('aria-busy','false'); return false;
}

/********** 欄位正規化（你指定的七欄） **********/
function normalizeMember(o){
  const v2 = (o['角色名稱']||o['角色職業']||o['等級']);
  if(v2){
    const ign=o['角色名稱']||''; const job=o['角色職業']||''; const lvl=Number(o['等級']||0); const note=o['乾表']||''; const zone=o['所在營區']||''; const code=o['角色代碼']||''; const guilder=o['公會成員']||'';
    return { 公會成員:guilder, 角色名稱:ign, 角色代碼:code, 角色職業:job, 等級:lvl, 乾表:note, 所在營區:zone,
      // 內部相容鍵（配對用）
      IGN:ign, UID:code, 職業:job, 戰力:lvl, 聯絡:zone, 備註:note, 是否外援: (String(guilder).includes('外援')?'是':'否') };
  }
  // 舊欄位回退
  return { IGN:o.IGN||'', UID:o.UID||'', 職業:o.職業||'', 戰力:Number(o.戰力||0), 聯絡:o.聯絡||'', 備註:o.備註||'', 是否外援:o.是否外援||'否' };
}

/********** CSV 解析 **********/
async function loadFromCSV(url){ try{ const res=await fetch(url,{cache:'no-store'}); const text=await res.text(); await loadFromCSVText(text);}catch(e){ toast('載入失敗'); console.error(e);} }
async function loadFromCSVText(text){
  const lines=text.split(/\r?\n/); if(!lines.length) return toast('資料為空');
  while(lines.length && !/,/.test(lines[0])) lines.shift();
  const headerLine=lines.shift(); if(!headerLine) return toast('找不到表頭');
  const headers=headerLine.split(',').map(h=>h.replace(/^\ufeff/,''));
  const rows=[]; let buf='';
  for(const line of lines){ buf+=(buf?'\n':'')+line; if((buf.match(/\"/g)||[]).length%2===0){ rows.push(buf); buf=''; } }
  if(buf) rows.push(buf);
  const list=rows.filter(Boolean).map(line=>{ const cells=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else inQ=!inQ; } else if(ch===',' && !inQ){ cells.push(cur); cur=''; } else cur+=ch; } cells.push(cur); const obj={}; headers.forEach((h,i)=>obj[h.trim()]=(cells[i]??'').trim()); return obj; });
  app.members=list.map(normalizeMember).filter(m=>m.角色名稱||m.IGN); saveApp(); renderMembers(); toast(`載入 ${app.members.length} 筆成員`);
}

/********** 呈現：公會成員 **********/
function renderMembers(){
  const tb=$('#memberTable tbody'); tb.innerHTML='';
  const q=$('#searchInput').value.trim().toLowerCase(); const fClass=$('#filterClass').value; const fMin=Number($('#filterLevelMin').value||0);
  const filtered=app.members.filter(m=>{ const name=m.角色名稱||m.IGN||''; const job=m.角色職業||m.職業||''; const dry=m.乾表||m.備註||''; const zone=m.所在營區||m.聯絡||''; if(q && !(name+job+dry+zone).toLowerCase().includes(q)) return false; if(fClass && job!==fClass) return false; if((m.等級??m.戰力??0)<fMin) return false; return true; });
  for(const m of filtered){ const tr=document.createElement('tr'); tr.innerHTML=`
    <td><strong>${m.角色名稱||m.IGN||'-'}</strong></td>
    <td>${m.角色職業||m.職業||''}</td>
    <td>${m.等級 ?? m.戰力 ?? 0}</td>
    <td>${m.乾表||m.備註||''}</td>
    <td>${m.所在營區||m.聯絡||''}</td>
    <td>${m.公會成員||''}</td>
    <td>${m.角色代碼||m.UID||''}</td>
    <td><button class="btn subtle" data-add="${m.IGN||m.角色名稱}">加入暫存</button></td>`; tb.appendChild(tr); }
}

/********** 配對（等級=戰力，職業均衡＋必帶/黑名單） **********/
function suggestTeam(){
  const total=parseInt($('#needTotal').value||12), minLv=parseInt($('#minLevel').value||0), cap=parseInt($('#perClassCap').value||0);
  const must=($('#mustList').value||'').split(/[，,]/).map(s=>s.trim()).filter(Boolean); const ban=($('#banList').value||'').split(/[，,]/).map(s=>s.trim()).filter(Boolean);
  const pool=app.members.filter(m=>!ban.includes(m.角色名稱||m.IGN) && (m.等級??m.戰力??0)>=minLv);
  const byClass={}; pool.forEach(m=>{ const c=m.角色職業||m.職業||'未分類'; (byClass[c]=byClass[c]||[]).push(m)});
  Object.values(byClass).forEach(arr=>arr.sort((a,b)=> (b.等級??b.戰力??0)-(a.等級??a.戰力??0)));
  const team=[]; const used=new Set();
  for(const name of must){ const m=pool.find(x=>(x.角色名稱||x.IGN)===name && !used.has(name)); if(m){team.push(m); used.add(name);} }
  let added=true; const count={}; Object.keys(byClass).forEach(k=>count[k]=0);
  while(team.length<total && added){ added=false; for(const cls of Object.keys(byClass)){ if(team.length>=total) break; if(cap>0 && count[cls]>=cap) continue; const cand=byClass[cls].find(m=>!used.has(m.角色名稱||m.IGN)); if(cand){ team.push(cand); used.add(cand.角色名稱||cand.IGN); count[cls]++; added=true; } } }
  if(team.length<total){ const rest=pool.filter(m=>!used.has(m.角色名稱||m.IGN)).sort((a,b)=>(b.等級??b.戰力??0)-(a.等級??a.戰力??0)); for(const m of rest){ if(team.length>=total) break; team.push(m);} }
  app.team=team; saveApp(); renderTeam(); toast('已產生建議隊伍');
}
function renderTeam(){ const z=$('#zone-team'); z.innerHTML=''; for(const m of app.team){ const el=document.createElement('div'); el.className='pill'; el.style.margin='6px 0'; el.textContent=`${m.角色名稱||m.IGN}（${m.角色職業||m.職業}｜Lv.${m.等級??m.戰力??0}）`; z.appendChild(el);} const avg=app.team.length? Math.round(app.team.reduce((a,b)=>a+(b.等級??b.戰力??0),0)/app.team.length):0; $('#teamSummary').textContent=`隊員 ${app.team.length} 人｜平均等級 ${avg}`; $('#teamScore').textContent=`分數：${app.team.length + Math.round(avg/10)}`; }
function exportTeamText(){ const rn=$('#raidName').value||'未命名 Raid'; const rt=$('#raidTime').value||'未定時間'; const lines=[`【${rn}】${rt}`,...app.team.map((m,i)=>`${i+1}. ${(m.角色名稱||m.IGN)}（${m.角色職業||m.職業}｜Lv.${m.等級??m.戰力??0}）`),`總數：${app.team.length}`]; return lines.join('\n'); }

/********** 意見回應 **********/
function addFeedback(){ const it={id:'fb_'+Date.now(),name:$('#fbName').value.trim()||'匿名',type:$('#fbType').value,content:$('#fbContent').value.trim(),public:$('#fbPublic').checked,ts:new Date().toISOString()}; if(!it.content) return toast('請輸入內容'); app.feedback.unshift(it); saveApp(); renderFeedback(); $('#fbContent').value=''; toast('已送出'); }
function renderFeedback(){ const q=$('#fbSearch').value.trim().toLowerCase(); const wrap=$('#fbList'); wrap.innerHTML=''; for(const it of app.feedback){ if(q && !(it.name+it.type+it.content).toLowerCase().includes(q)) continue; if(!it.public) continue; const row=document.createElement('div'); row.className='pill'; row.style.padding='10px 12px'; row.style.margin='8px 0'; row.innerHTML=`<div style="display:flex;justify-content:space-between;gap:10px;align-items:center"><div><strong>${it.type}</strong> <span class="muted">｜${new Date(it.ts).toLocaleString()}</span><div class="muted">by ${it.name}</div><div style="margin-top:6px">${(it.content||'').replace(/[&<>\"]/g,' ')}</div></div><div class="row inline"><button class="btn subtle" data-edit="${it.id}">編輯</button><button class="btn subtle" data-del="${it.id}">刪除</button></div></div>`; wrap.appendChild(row);} }

/********** 匯出 / 匯入 / 快照 **********/
function exportJSON(){ const data={members:app.members,team:app.team,settings:app.settings,feedback:app.feedback}; download('index.json', JSON.stringify(data,null,2)); }
function exportCSV(){ download('index.csv', toCSV(app.members), 'text/csv'); }
function importFile(file){ const r=new FileReader(); r.onload=()=>{ const t=r.result; if(file.name.endsWith('.json')){ try{ const d=JSON.parse(t); Object.assign(app,d); saveApp(); renderMembers(); renderTeam(); renderFeedback(); toast('JSON 匯入完成') }catch{ toast('JSON 格式錯誤') } } else if(file.name.endsWith('.csv')){ const [h,...ls]=t.split(/\r?\n/).filter(Boolean); const hs=h.split(','); const rows=ls.map(l=>{ const cs=l.split(','); const o={}; hs.forEach((x,i)=>o[x.trim()]=cs[i]); return o }); app.members=rows.map(normalizeMember); saveApp(); renderMembers(); toast('CSV 匯入完成') } }; r.readAsText(file) }
function snapshotTeam(){ const c=$('#snapshotCanvas'); const ctx=c.getContext('2d'); ctx.fillStyle='#0B0F1A'; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='#fff'; ctx.font='28px ui-sans-serif'; const rn=$('#raidName').value||'未命名 Raid'; const rt=$('#raidTime').value||'未定時間'; ctx.fillText(`【${rn}】${rt}`,24,42); ctx.fillStyle='#E5E7EB'; ctx.font='16px ui-sans-serif'; app.team.forEach((m,i)=>ctx.fillText(`${i+1}. ${(m.角色名稱||m.IGN)}（${m.角色職業||m.職業}｜Lv.${m.等級??m.戰力??0}）`,24,80+i*22)); c.toBlob(b=>{ if(!b) return; download('index.png', b, 'image/png') }) }

/********** 事件與啟動 **********/
function switchTab(name){ $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name)); $$('.tab').forEach(s=>s.classList.toggle('hidden', s.id!==`tab-${name}`)); $('#mobileMenu').classList.add('hidden') }
function bindEvents(){
  document.addEventListener('click', e=>{
    const btn=e.target.closest('.tab-btn'); if(btn){ switchTab(btn.dataset.tab) }
    if(e.target.id==='refreshBtn') renderMembers();
    if(e.target.id==='btnSuggest') suggestTeam();
    if(e.target.id==='btnDemoTeam'){ $('#needTotal').value=12; $('#perClassCap').value=3; $('#minLevel').value=200; toast('已載入示例') }
    if(e.target.id==='btnClearTeam'){ app.team=[]; saveApp(); renderTeam(); }
    if(e.target.id==='btnExportTeam'){ const txt=exportTeamText(); navigator.clipboard?.writeText(txt); download('index.txt', txt, 'text/plain') }
    if(e.target.id==='btnAddFeedback') addFeedback();
    if(e.target.id==='btnClearFB'){ if(confirm('確定清空本機所有意見？')){ app.feedback=[]; saveApp(); renderFeedback() } }
    if(e.target.id==='btnExportJSON') exportJSON();
    if(e.target.id==='btnExportCSV') exportCSV();
    if(e.target.id==='btnImport'){ const f=$('#fileImport').files[0]; if(!f) return toast('請先選擇檔案'); importFile(f) }
    if(e.target.id==='btnSnapshot') snapshotTeam();
    if(e.target.id==='btnLoadSheet'){ const editUrl=$('#sheetUrl').value||app.settings.sheetUrl; const name=$('#sheetName').value||app.settings.sheetName||'基本資料表'; if(!editUrl) return toast('請先填入來源'); app.settings.sheetUrl=editUrl; app.settings.sheetName=name; saveApp(); tryLoadSheet(editUrl, name) }
    if(e.target.id==='btnSaveEndpoint'){ app.settings.sheetUrl=$('#sheetUrl').value; app.settings.sheetName=$('#sheetName').value||'基本資料表'; saveApp(); toast('已保存') }
    if(e.target.closest('[data-add]')){ const ign=e.target.closest('[data-add]').dataset.add; const m=app.members.find(x=>(x.IGN||x.角色名稱)===ign); if(m){ app.team.push(m); saveApp(); renderTeam(); toast(`已加入 ${ign}`) } }
  });
  ['searchInput','filterClass','filterLevelMin'].forEach(id=>{ const el=$('#'+id); el.addEventListener('input',renderMembers); el.addEventListener('change',renderMembers) });
  $('.burger').addEventListener('click',()=>$('#mobileMenu').classList.remove('hidden'));
  $('#mobileMenu').addEventListener('click',e=>{ if(e.target.id==='mobileMenu') $('#mobileMenu').classList.add('hidden') });
  $('#fileImport').addEventListener('change',e=>{ const f=e.target.files[0]; if(f) importFile(f) });
}
function init(){
  // 預設你的試算表連結與分頁名稱（可直接使用你提供的連結）
  const defaultSheetEditUrl='https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?usp=sharing';
  app.settings.sheetUrl=app.settings.sheetUrl||defaultSheetEditUrl; app.settings.sheetName=app.settings.sheetName||'基本資料表';
  $('#sheetUrl').value=app.settings.sheetUrl; $('#sheetName').value=app.settings.sheetName; $('#gasUrl').value=app.settings.gasUrl||''; $('#gasToken').value=app.settings.gasToken||'';
  // 啟動即嘗試撈取（多端點策略）
  tryLoadSheet(app.settings.sheetUrl, app.settings.sheetName);
  renderMembers(); renderTeam(); renderFeedback(); bindEvents();
}
window.addEventListener('load', init);
</script>