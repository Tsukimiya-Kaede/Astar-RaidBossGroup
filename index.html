<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>è§’è‰²è³‡æ–™æª¢è¦–å·¥å…·ï¼ˆè‡ªå‹•è®€å–ç‰ˆï¼‰</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- Bootstrap JS (Modal éœ€è¦) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    .status-badge { font-size: 0.85rem; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
    button.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    #sourceBadge { display: none !important; }
	
	<!-- /* åˆ†é å¤–æ¡† + é¡è‰² */ -->
	.nav-tabs-custom .nav-link{
	  border:2px solid transparent;
	  font-weight:600;
	  margin-right:.5rem;
	}
	.nav-tabs-custom .nav-link:hover{
	  opacity:.9;
	}

	<!-- /* æ‹‰åœ–æ–¯ï¼ˆè—ï¼‰ */ -->
	.nav-tabs-custom .tab-latus{
	  color:#0d6efd;
	  border-color:#0d6efd;
	}
	.nav-tabs-custom .tab-latus.active{
	  color:#fff;
	  background:#0d6efd;
	}

	<!-- /* æ®˜æš´ç‚é­”ï¼ˆæ©˜ï¼‰ */ -->
	.nav-tabs-custom .tab-zakum{
	  color:#fd7e14;
	  border-color:#fd7e14;
	}
	.nav-tabs-custom .tab-zakum.active{
	  color:#fff;
	  background:#fd7e14;
	}

	<!-- /* è¨“ç·´ç‡Ÿ&å¤–æ´ï¼ˆé»‘ï¼‰ */ -->
	.nav-tabs-custom .tab-misc{
	  color:#212529;
	  border-color:#212529;
	}
	.nav-tabs-custom .tab-misc.active{
	  color:#fff;
	  background:#212529;
	}

  </style>
</head>
<body class="bg-body">
  <nav class="navbar navbar-expand-lg bg-primary navbar-dark">
    <div class="container-fluid">
      <span class="navbar-brand">ğŸMapleStory Astarå…¬æœƒå°ˆå±¬ç¶²ç«™ğŸ-0231</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="sourceBadge" class="badge bg-light text-dark status-badge d-none"></span>
        <!-- ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å°æŒ‰éˆ• -->
        <a href="https://artale-market.org/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm" title="ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å°">ğŸª ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å°</a>
        <!-- æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·æŒ‰éˆ•ï¼ˆæ€ªç‰©åœ–æ¡ˆï¼‰ -->
        <a href="https://a2983456456.github.io/artale-drop/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm" title="æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·">ğŸ‘¾ æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·</a>
        <!-- å¥³ç¥ 400 é€Ÿè§£å°å·¥å…·æŒ‰éˆ• -->
        <a href="https://rvgin.github.io/tower-of-goddess/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm" title="å¥³ç¥ 400 é€Ÿè§£å°å·¥å…·">ğŸ‘¸ å¥³ç¥ 400 é€Ÿè§£å°å·¥å…·</a>
        <!-- è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨æŒ‰éˆ• -->
        <a href="https://philipc-1.github.io/MapleStory/HPsimulator.html" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm" title="è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨">ğŸ’Š è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨</a>
        <button id="Zakum" class="btn btn-outline-light btn-sm">ğŸ—¿ æ®˜æš´ç‚é­”æ”»ç•¥</button>
        <button id="toggleTheme" class="btn btn-outline-light btn-sm">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
      </div>
    </div>
  </nav>

  <div id="homePage" class="container py-4">
    <!-- æç¤ºå¡ç‰‡ -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">è³‡æ–™ä¾†æº</h5>
        <p class="mb-0 text-muted">è«‹å„ä½æª¢è¦–ä¸€ä¸‹è‡ªå·±çš„è³‡æ–™æ˜¯å¦é ˆæ›´æ–°ï¼Œè‹¥è¦æ›´æ–°è«‹é»æ“Šã€ä¿®æ”¹ã€‘æŒ‰éˆ•é€²è¡Œæ›´æ–°ã€‚è‹¥é‡ç„¡æ³•æ›´æ–°æƒ…å½¢è«‹é€²ä»¥ä¸‹ç¶²å€é€²å…¥Excelè¡¨æ‰¾åˆ°è‡ªå·±çš„æ¬„ä½æ›´æ–°è³‡æ–™ ã€€ï½æ„Ÿæ©çš„å¿ƒï½</p>
        <small class="text-muted">
          <a href="https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer">
            https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0
          </a>
        </small>
        <div id="msg" class="text-danger mt-2"></div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-0">è§’è‰²æ¸…å–®</h5>
          <div class="d-flex align-items-center gap-2">
            <button id="addBtn" class="btn btn-primary btn-sm">æ–°å¢è§’è‰²</button>
            <button id="reloadBtn" class="btn btn-outline-secondary btn-sm">é‡æ–°æ•´ç†</button>
          </div>
        </div>

        <!-- â˜… æ–°å¢ï¼šåˆ†é åˆ‡æ›ï¼ˆåƒ…åˆ‡æ›é¡¯ç¤ºç‡Ÿå€ï¼‰ -->
        <ul class="nav nav-pills nav-tabs-custom mb-3" id="campTabs" role="tablist">
		  <li class="nav-item" role="presentation">
			<button id="tabLatus" class="nav-link tab-latus active" type="button" role="tab">æ‹‰åœ–æ–¯</button>
		  </li>
		  <li class="nav-item" role="presentation">
			<button id="tabZakumList" class="nav-link tab-zakum" type="button" role="tab">æ®˜æš´ç‚é­”</button>
		  </li>
		  <li class="nav-item" role="presentation">
			<button id="tabTrainExt" class="nav-link tab-misc" type="button" role="tab">è¨“ç·´ç‡Ÿ&å¤–æ´å°ˆå€</button>
		  </li>
		</ul>


        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead class="table-secondary">
              <tr>
                <th>è§’è‰²åç¨±</th>
                <th>è§’è‰²ä»£ç¢¼</th>
                <th>è§’è‰²è·æ¥­</th>
                <th>è§’è‰²ç­‰ç´š</th>
                <th>è§’è‰²ä¹¾è¡¨</th>
                <th>æ‰€åœ¨ç‡Ÿå€</th>
                <th>ä¿®æ”¹è³‡æ–™</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="7" class="text-center text-muted">å°šæœªè®€å–è³‡æ–™</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Zakum æ®˜æš´ç‚é­”æ”»ç•¥ï¼ˆé è¨­éš±è—ï¼‰ -->
  <div id="zakumPage" class="container py-4 d-none">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0">ğŸ—¿ æ®˜æš´ç‚é­”æ”»ç•¥ï¼ˆZakum Guideï¼‰â€»AIç²¾ç°¡ç‰ˆ æœƒå†å¾®èª¿â€»</h3>
      <button id="backToList" class="btn btn-outline-secondary btn-sm">â† è¿”å›è§’è‰²æ¸…å–®</button>
    </div>

	<div class="card shadow-sm mb-3">
	  <div class="card-body">
		<h5 class="card-title mb-2">å®˜æ–¹æ”»ç•¥æ–‡ä»¶ï¼ˆå…§åµŒï¼‰</h5>
		<!-- Bootstrap éŸ¿æ‡‰å¼æ¯”ä¾‹ç›’ï¼Œè®“ iframe è‡ªé©æ‡‰å¤§å° -->
		<div class="ratio ratio-16x9">
		  <iframe id="zakumDocFrame" src="" title="Zakum Guide Doc" allowfullscreen style="border:0;"></iframe>
		</div>
		<small class="text-muted d-block mt-2">
		  è‹¥æœªé¡¯ç¤ºï¼Œè«‹ç¢ºèª Google æ–‡ä»¶å·²ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€æˆ–æ¬Šé™è¨­å®šå…è¨±å…§åµŒã€‚
		</small>
	  </div>
	</div>

  </div>

<script>
// æ®˜æš´ç‚é­”æ”»ç•¥ï¼šGoogle æ–‡ä»¶åµŒå…¥ç¶²å€ï¼ˆå»ºè­°ç”¨ç™¼ä½ˆåˆ°ç¶²è·¯å¾Œçš„ /pub?embedded=trueï¼‰
//const ZAKUM_DOC_EMBED = "https://docs.google.com/document/d/19iRUhl0Es049i5dgVkJlBAuDK3icESjuEqmAGj44cHs/pub?embedded=true";
// è‹¥æœªç™¼ä½ˆã€ä½†åˆ†äº«æ¬Šé™é–‹æ”¾ï¼Œä¹Ÿå¯æš«ç”¨ previewï¼ˆå¯èƒ½æœƒè¢« X-Frame-Options æ“‹ï¼‰
 const ZAKUM_DOC_EMBED = "https://docs.google.com/document/d/19iRUhl0Es049i5dgVkJlBAuDK3icESjuEqmAGj44cHs/preview";

/* =========================
   è¨­å®šï¼šè«‹å¡«ä½ çš„ Apps Script Web Appï¼ˆexecï¼‰URL
========================= */
const GAS_UPDATE_URL = 'https://script.google.com/macros/s/AKfycbwbEW15caNLWOUqm8VKby2tN_JfCySTT6xFtreuFz9K0Ex51qioyeqNi476jVH4vlGo/exec';

/* =========================
   å¤œé–“æ¨¡å¼åˆ‡æ›
========================= */
$('#toggleTheme').on('click', function () {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-bs-theme') === 'dark';
  html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
  $(this).text(isDark ? 'ğŸŒ™ å¤œé–“æ¨¡å¼' : 'â˜€ï¸ æ—¥é–“æ¨¡å¼');
});

/* =========================
   æ®˜æš´ç‚é­”æ”»ç•¥ï¼šå–®é åˆ‡æ›
========================= */
$('#Zakum').on('click', function () {
  $('#homePage').addClass('d-none');   // éš±è—æ¸…å–®
  $('#zakumPage').removeClass('d-none'); // é¡¯ç¤ºæ”»ç•¥
});
$(document).on('click', '#backToList', function () {
  $('#zakumPage').addClass('d-none');
  $('#homePage').removeClass('d-none');
});
// åªåœ¨ç¬¬ä¸€æ¬¡æˆ–æ¯æ¬¡åˆ‡æ›æ™‚è¨­å®š/é‡è¨­ srcï¼ˆé¿å…é‡è¤‡è¼‰å…¥ä¹Ÿå¯ä»¥åŠ åˆ¤æ–·ï¼‰
  const $frame = $('#zakumDocFrame');
  if ($frame.attr('src') !== ZAKUM_DOC_EMBED) {
    $frame.attr('src', ZAKUM_DOC_EMBED);
  }

/* =========================
   å…¬ç”¨ï¼šè§£æ URL åƒæ•¸
========================= */
function getQueryParams() {
  const params = new URLSearchParams(window.location.search);
  return Object.fromEntries(params.entries());
}
function parseSheetFromUrl(url) {
  if (!url) return null;
  const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
  if (!idMatch) return null;
  const sheetId = idMatch[1];
  const urlObj = new URL(url);
  const gid = urlObj.searchParams.get('gid') || (url.includes('#gid=') ? url.split('#gid=')[1] : '0');
  return { sheetId, gid };
}

/* =========================
   å…¨åŸŸç‹€æ…‹ï¼ˆâ˜… æ–°å¢ï¼‰
========================= */
let currentTab = 'latus';   // 'latus' | 'zakum'
let lastData   = [];        // è®€å–å¾Œä¿å­˜ï¼Œåˆ‡åˆ†é æ™‚é‡ç¹ªä½¿ç”¨

/* =========================
   è®€å– Google Sheetï¼ˆä»¥ CSV åŒ¯å‡ºï¼‰
========================= */
function loadFromSheet(sheetId, gid = '0') {
  $('#msg').text('');
  $('#tableBody').html(`
    <tr>
      <td colspan="7" class="text-center text-muted">è®€å–ä¸­...</td>
    </tr>
  `);

  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;

  Papa.parse(csvUrl, {
    download: true,
    skipEmptyLines: true,
    complete: function (result) {
      try {
        if (!result.data || result.data.length < 2) {
          $('#msg').text('æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º');
          lastData = [];
          renderTable(lastData);
          return;
        }

        const rows = result.data.slice(1);
        lastData = rows
          .map((r, i) => ({
            name:  r[1], // B
            code:  r[2], // Cï¼ˆä¸»éµï¼‰
            job:   r[3], // D
            level: r[4], // E
            attack:r[6], // F ä¹¾è¡¨
            camp:  r[9], // G ç‡Ÿå€
            rowIndex: i + 2
          }))
          .filter(r => r && r.name);

        renderTable(lastData);
      } catch (e) {
        console.error(e);
        $('#msg').text('è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
        lastData = [];
        renderTable(lastData);
      }
    },
    error: function (err) {
      console.error(err);
      $('#msg').text('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè©² Google Sheet å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ã€‚');
      lastData = [];
      renderTable(lastData);
    }
  });
}

/* =========================
   ä¾åˆ†é éæ¿¾ + åˆ†çµ„é¡¯ç¤ºï¼ˆâ˜… èª¿æ•´ï¼‰
========================= */
function renderTable(data) {
  // ä¾ç›®å‰åˆ†é éæ¿¾ç‡Ÿå€
  const zhNums = 'ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å';
  const reLatus = new RegExp(`^æ‹‰åœ–[${zhNums}]ç‡Ÿ$`);
  const reZakum = new RegExp(`^ç‚é­”[${zhNums}]ç‡Ÿ$`);

  const filtered = (data || []).filter(r => {
    const camp = (r.camp || '').trim();
    if (currentTab === 'latus')   return reLatus.test(camp);
    if (currentTab === 'zakum')   return reZakum.test(camp);
    if (currentTab === 'trainext')return (camp === 'è¨“ç·´ç‡Ÿ' || camp === 'å¤–æ´å¤§å¤§');
    return true;
  });

  // ...ï¼ˆä½ åŸæœ¬ renderTable å¾ŒçºŒçš„åˆ†çµ„/æ’åº/è¼¸å‡ºä¿æŒä¸è®Šï¼‰


  if (!filtered.length) {
    $('#tableBody').html(`
      <tr>
        <td colspan="7" class="text-center text-muted">æ­¤åˆ†é ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td>
      </tr>
    `);
    return;
  }

  // ä¾ç‡Ÿå€åˆ†çµ„
  const groups = {};
  for (const r of filtered) {
    const key = (r.camp || 'æœªå¡«å¯«').toString().trim();
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  }

  // ä¾ã€Œä¸€äºŒä¸‰â€¦åã€æ’åº
  const mapCN = { 'é›¶':0,'ã€‡':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10 };
  function chineseNumToInt(txt) {
    if (!txt) return NaN;
    const m = txt.match(/[é›¶ã€‡ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/g);
    if (!m) return NaN;
    const s = m.join('');
    if (s === 'å') return 10;
    const tenIdx = s.indexOf('å');
    if (tenIdx === -1) return mapCN[s] ?? NaN;
    const left = tenIdx === 0 ? 1 : (mapCN[s[0]] ?? 0);
    const right = tenIdx === s.length - 1 ? 0 : (mapCN[s[tenIdx+1]] ?? 0);
    return left * 10 + right;
  }

  const orderedKeys = Object.keys(groups).sort((a,b) => {
    const na = chineseNumToInt(a);
    const nb = chineseNumToInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return a.localeCompare(b, 'zh-Hant');
  });

  let html = '';
  for (const k of orderedKeys) {
    html += `
      <tr class="group-row">
        <td colspan="7">æ‰€åœ¨ç‡Ÿå€ï¼š${k}ï¼ˆ${groups[k].length}ï¼‰</td>
      </tr>`;
    html += groups[k].map(r => `
      <tr>
        <td>${r.name ?? ''}</td>
        <td>${r.code ?? ''}</td>
        <td>${r.job ?? ''}</td>
        <td>${r.level ?? ''}</td>
        <td>${r.attack ?? ''}</td>
        <td>${r.camp ?? ''}</td>
        <td>
          <button class="btn btn-outline-secondary btn-edit"
            data-row="${r.rowIndex || ''}"
            data-name="${r.name ?? ''}"
            data-code="${r.code ?? ''}"
            data-job="${r.job ?? ''}"
            data-level="${r.level ?? ''}"
            data-attack="${r.attack ?? ''}"
            data-camp="${r.camp ?? ''}">ä¿®æ”¹</button>
        </td>
      </tr>`).join('');
  }

  $('#tableBody').html(html);

  // ç¶å®šã€Œä¿®æ”¹ã€
  $('#tableBody').off('click', '.btn-edit').on('click', '.btn-edit', function(){
    const $btn = $(this);
    openEditor({
      name:  $btn.data('name'),
      code:  $btn.data('code'),
      job:   $btn.data('job'),
      level: $btn.data('level'),
      attack:$btn.data('attack'),
      camp:  $btn.data('camp'),
      rowIndex: Number($btn.data('row') || 0)
    }, (updated) => {
      // æ›´æ–°å‰ç«¯ç•¶åˆ—
      const tr = $btn.closest('tr')[0];
      const tds = tr.querySelectorAll('td');
      tds[0].textContent = updated.name;
      tds[1].textContent = updated.code;
      tds[2].textContent = updated.job;
      tds[3].textContent = updated.level;
      tds[4].textContent = updated.attack;
      tds[5].textContent = updated.camp;

      $btn.data('name',  updated.name);
      $btn.data('code',  updated.code);
      $btn.data('job',   updated.job);
      $btn.data('level', updated.level);
      $btn.data('attack',updated.attack);
      $btn.data('camp',  updated.camp);
    });
  });
}

/* =========================
   åˆ†é åˆ‡æ›ï¼ˆâ˜… æ–°å¢ï¼‰
========================= */
function setTab(tab) {
  currentTab = tab; // 'latus' | 'zakum' | 'trainext'
  // åˆ‡æ›æ¨£å¼
  $('#tabLatus').toggleClass('active', tab === 'latus');
  $('#tabZakumList').toggleClass('active', tab === 'zakum');
  $('#tabTrainExt').toggleClass('active', tab === 'trainext');
  // ä¾ç›®å‰åˆ†é é‡ç¹ª
  renderTable(lastData);
}

	$('#tabLatus').on('click',     () => setTab('latus'));
	$('#tabZakumList').on('click', () => setTab('zakum'));
	$('#tabTrainExt').on('click',  () => setTab('trainext'));


/* =========================
   å•Ÿå‹•æµç¨‹ï¼šè‡ªå‹•è®€å–
========================= */
const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0';
function resolveSheetTarget() {
  const qp = getQueryParams();
  if (qp.sheetUrl) {
    const parsed = parseSheetFromUrl(qp.sheetUrl);
    if (parsed) return parsed;
  }
  if (qp.sheetId) {
    return { sheetId: qp.sheetId, gid: qp.gid || '0' };
  }
  const parsedDefault = parseSheetFromUrl(DEFAULT_SHEET_URL);
  return parsedDefault || { sheetId: '', gid: '0' };
}
function updateSourceBadge(sheetId, gid) {
  if (!sheetId) return;
  const badge = $('#sourceBadge');
  badge.text(`sheetId=${sheetId} | gid=${gid}`);
  badge.removeClass('d-none');
}

$(function () {
  const target = resolveSheetTarget();
  if (!target.sheetId) {
    $('#msg').text('ç„¡æ³•è§£ææŒ‡å®šçš„ Google Sheet é€£çµæˆ– sheetId');
    return;
  }
  updateSourceBadge(target.sheetId, target.gid);
  loadFromSheet(target.sheetId, target.gid);

  $('#reloadBtn').on('click', function () {
    loadFromSheet(target.sheetId, target.gid);
  });

  $('#addBtn').on('click', function () {
    openEditor({
      name: '', code: '', job: '', level: '', attack: '', camp: '',
      rowIndex: 0, __isNew: true
    }, () => { alert('å·²æ–°å¢'); });
  });
});

/* =========================
   ç·¨è¼¯è¦–çª—ï¼ˆå«ç‡Ÿå€ä¸‹æ‹‰ï¼‰â€” ä¿ç•™ä½ åŸæœ¬çš„å¯«å› GAS åšæ³•
========================= */
function createEditor() {
  const overlay = document.createElement('div');
  overlay.id = 'editOverlay';
  Object.assign(overlay.style, {
    position: 'fixed', inset: 0, background: 'rgba(0,0,0,.4)',
    display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
  });

  const card = document.createElement('div');
  Object.assign(card.style, {
    background: '#fff', borderRadius: '12px', padding: '18px', width: 'min(520px, 92vw)',
    boxShadow: '0 10px 30px rgba(0,0,0,.2)', color: '#222', fontFamily: 'system-ui,-apple-system,BlinkMacSystemFont'
  });
  card.innerHTML = `
    <h3 style="margin:0 0 12px;font-size:18px;">ä¿®æ”¹è³‡æ–™</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²åç¨±ï¼ˆBï¼‰</span>
        <input id="edit_name" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ä»£ç¢¼ï¼ˆCï¼‰</span>
        <input id="edit_code" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²è·æ¥­ï¼ˆDï¼‰</span>
        <input id="edit_job" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ç­‰ç´šï¼ˆEï¼‰</span>
        <input id="edit_level" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>è§’è‰²ä¹¾è¡¨ï¼ˆFï¼‰</span>
        <input id="edit_attack" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      </label>
      <label style="display:flex;flex-direction:column;gap:6px;">
        <span>æ‰€åœ¨ç‡Ÿå€ï¼ˆGï¼‰</span>
        <select id="edit_camp" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
          <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
          <!-- ä¾ä½ å¯¦éš›ä½¿ç”¨çš„ç‡Ÿå€å­—æ¨£ç¶­æŒå³å¯ -->
          <option>æ‹‰åœ–ä¸€ç‡Ÿ</option><option>æ‹‰åœ–äºŒç‡Ÿ</option><option>æ‹‰åœ–ä¸‰ç‡Ÿ</option><option>æ‹‰åœ–å››ç‡Ÿ</option><option>æ‹‰åœ–äº”ç‡Ÿ</option>
          <option>æ‹‰åœ–å…­ç‡Ÿ</option><option>æ‹‰åœ–ä¸ƒç‡Ÿ</option><option>æ‹‰åœ–å…«ç‡Ÿ</option><option>æ‹‰åœ–ä¹ç‡Ÿ</option><option>æ‹‰åœ–åç‡Ÿ</option>
          <option>ç‚é­”ä¸€ç‡Ÿ</option><option>ç‚é­”äºŒç‡Ÿ</option><option>ç‚é­”ä¸‰ç‡Ÿ</option><option>ç‚é­”å››ç‡Ÿ</option><option>ç‚é­”äº”ç‡Ÿ</option>
          <option>ç‚é­”å…­ç‡Ÿ</option><option>ç‚é­”ä¸ƒç‡Ÿ</option><option>ç‚é­”å…«ç‡Ÿ</option><option>ç‚é­”ä¹ç‡Ÿ</option><option>ç‚é­”åç‡Ÿ</option>
          <option>è¨“ç·´ç‡Ÿ</option><option>å¤–æ´å¤§å¤§</option>
        </select>
      </label>
    </div>
    <div class="d-flex gap-2 justify-content-end mt-3">
      <button id="btn_cancel" class="btn btn-light border">å–æ¶ˆ</button>
      <button id="btn_save" class="btn btn-primary">å„²å­˜</button>
    </div>
  `;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  return overlay;
}

function openEditor(values, onSave) {
  let overlay = document.getElementById('editOverlay');
  if (!overlay) overlay = createEditor();

  overlay.querySelector('#edit_name').value   = values.name  ?? '';
  overlay.querySelector('#edit_code').value   = values.code  ?? '';
  overlay.querySelector('#edit_job').value    = values.job   ?? '';
  overlay.querySelector('#edit_level').value  = values.level ?? '';
  overlay.querySelector('#edit_attack').value = values.attack?? '';

  const campSelect = overlay.querySelector('#edit_camp');
  const campValue  = values.camp ?? '';
  if (campValue) {
    const exists = Array.from(campSelect.options).some(o => o.value === campValue || o.text === campValue);
    if (!exists) campSelect.add(new Option(campValue, campValue));
    campSelect.value = campValue;
  } else {
    campSelect.value = '';
  }

  const btnCancel = overlay.querySelector('#btn_cancel');
  const btnSave   = overlay.querySelector('#btn_save');
  const close = () => overlay.remove();
  btnCancel.onclick = close;

  btnSave.onclick = async () => {
    const updated = {
      name:   overlay.querySelector('#edit_name').value.trim(),
      code:   overlay.querySelector('#edit_code').value.trim(),
      job:    overlay.querySelector('#edit_job').value.trim(),
      level:  overlay.querySelector('#edit_level').value.trim(),
      attack: overlay.querySelector('#edit_attack').value.trim(),
      camp:   overlay.querySelector('#edit_camp').value.trim(),
    };
    const isNew = !!values.__isNew;

    if (!GAS_UPDATE_URL || GAS_UPDATE_URL.includes('/dev')) {
      alert('è«‹è¨­å®šæ­£ç¢ºçš„ GAS_UPDATE_URLï¼ˆå¿…é ˆæ˜¯ /execï¼‰');
      return;
    }
    if (!updated.code) {
      alert('è§’è‰²ä»£ç¢¼ä¸å¯ç‚ºç©ºï¼ˆç”¨ä¾†å®šä½è¦æ›´æ–°çš„åˆ—ï¼‰');
      return;
    }

    try {
      const form = new URLSearchParams();
      form.set('action', 'upsertByCode');
      form.set('code',   updated.code);
      form.set('name',   updated.name);
      form.set('job',    updated.job);
      form.set('level',  updated.level);
      form.set('attack', updated.attack);
      form.set('camp',   updated.camp);

      const resp = await fetch(GAS_UPDATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString(),
        cache: 'no-store',
        redirect: 'follow'
      });

      const text = await resp.text();
      let result;
      try { result = JSON.parse(text); } catch {
        throw new Error('GAS å›å‚³é JSONï¼Œè«‹ç¢ºèª Web App ç”¨ /exec ä¸”ã€Œä»»ä½•äººã€å¯å­˜å–ã€‚');
      }
      if (!resp.ok || result.status !== 'ok') {
        throw new Error(result.message || 'æ›´æ–°/æ–°å¢å¤±æ•—');
      }

      if (isNew) {
        const t = resolveSheetTarget();
        loadFromSheet(t.sheetId, t.gid);
      } else {
        onSave?.(updated);
      }
      alert(isNew ? 'æ–°å¢æˆåŠŸï¼' : 'æ›´æ–°æˆåŠŸï¼');
      close();
    } catch (e) {
      console.error(e);
      alert('é€å‡ºå¤±æ•—ï¼š' + e.message);
    }
  };
}
</script>
</body>
</html>
